{% extends "base.html" %}
{% load staticfiles %}

{% block headers %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
<!-- <link rel="stylesheet" href="{% static 'highlight/styles/default.css' %}"> -->
<script src="https://cdn.jsdelivr.net/npm/vega@5.0.0-rc2/build/vega.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc13/build/vega-lite.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@3.29.1/build/vega-embed.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
crossorigin=""/>
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
crossorigin=""></script>
<!-- Load Esri Leaflet from CDN -->
<script src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
crossorigin=""></script>
<style>
  #map { height: 500px; }
</style>

<style media="screen">
  /* Add space between Vega-Embed links  */
  .vega-actions a {
    margin-right: 5px;
  }
</style>
{% endblock headers %}

{% block content %}

<!-- Main jumbotron for a primary marketing message or call to action -->
<div style="text-align:center">
  <div class="jumbotron">
    <div class="container">
      <h1>PVLIB API</h1>
      <p class="lead">Software for simulating photovoltaic solar energy systems.</p>
    </div><!-- /.container -->
  </div>
</div>

<div class="container">
  <h1 class="page-header">Solar Position</h1>
  <p>
    The first step to modeling a PV system is to get the solar position for the
    site. Use the PVLIB API by sending a <code>GET</code> request to
    <code>/api/v1/pvlib/solarposition/</code>, the response is <code>JSON</code>.
    The calculation requires the following parameters:
  </p>
  <ul>
    <li><code>lat</code> - latitude in degrees</li>
    <li><code>lon</code> - longitude in degrees</li>
    <li><code>start</code> - start date/time</li>
    <li><code>end</code> - end date/time</li>
    <li><code>freq</code> - (optional) frequency as pandas offset alias [default hourly, <code>H</code>]</li>
    <li><code>tz</code> - (optional) timezone in hours [default zero]</li>
  </ul>
  <p>
    <i>Note: the API uses <a href="https://pandas.pydata.org/pandas-docs/stable/index.html">pandas</a>
    to parse dates and times, see the documentation for formats.</i>
  </p>
  <h2>Example</h2>
  <p>
    Try the following:
    <a href="/api/v1/pvlib/solarposition/?lat=38&lon=-122&start=2018-01-01 7:00&end=2018-01-01 8:00&freq=T&tz=-8" target="_blank">
    <code>/api/v1/pvlib/solarposition/?lat=38&lon=-122&start=2018-01-01 7:00&end=2018-01-01 8:00&freq=T&tz=-8</code></a>
  </p>
  <br/>
  <form id="solposform">
    <div class="row">
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.solposform.lat.errors }}
        {{ forms.solposform.lat.label_tag }}
        {{ forms.solposform.lat }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.solposform.lon.errors }}
        {{ forms.solposform.lon.label_tag }}
        {{ forms.solposform.lon }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.solposform.start.errors }}
        {{ forms.solposform.start.label_tag }}
        {{ forms.solposform.start }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.solposform.end.errors }}
        {{ forms.solposform.end.label_tag }}
        {{ forms.solposform.end }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.solposform.freq.errors }}
        {{ forms.solposform.freq.label_tag }}
        {{ forms.solposform.freq }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.solposform.tz.errors }}
        {{ forms.solposform.tz.label_tag }}
        {{ forms.solposform.tz }}
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-2">
        <button id="solposbutton" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </form>
  <br/>
  <p>Click on the map and enter the dates and frequency fields above, then
    click submit to see what your request looks like, a plot of azimuth vs.
    zenith, and a <a href="#solpos">table of solar positions</a> below:</p>
  <span id="solpos_code"></span>

  <div id="map"></div>
  <script>
    var solpos_map = L.map("map").setView([37.75, -122.23], 10);
    L.esri.basemapLayer("Topographic").addTo(solpos_map);
    var marker_layer = L.layerGroup().addTo(solpos_map);

    function onMapClick(e) {
      marker_layer.clearLayers();
      var marker = L.marker(e.latlng).addTo(marker_layer);
      marker.bindPopup(e.latlng.toString()).openPopup();
      $("#id_lat").val(e.latlng.lat);
      $("#id_lon").val(e.latlng.lng);
      $("#id_tz").val(Math.round(e.latlng.lng/15));
      $("#id_tl_lat").val(e.latlng.lat);
      $("#id_tl_lon").val(e.latlng.lng);
      $("#id_tl_tz").val(Math.round(e.latlng.lng/15));
    }

    solpos_map.on('click', onMapClick);
  </script>

  <div id="vis"></div>
  <div id="solpos"></div>
</div>
<div class="container">
  <h1 class="page-header">Linke Turbidity</h1>
  <p>If you want to calculate clear sky you may need Linke Turbidity or AOD and precipitable water.</p>
  <h2>Example</h2>
  <p>
    Try the following:
    <a href="/api/v1/pvlib/linke-turbidity/?tl_lat=38&tl_lon=-122&tl_start=2018-01-01 7:00&tl_end=2018-01-01 8:00&tl_freq=T&tl_tz=-8" target="_blank">
    <code>/api/v1/pvlib/linke-turbidity/?tl_lat=38&tl_lon=-122&tl_start=2018-01-01 7:00&tl_end=2018-01-01 8:00&tl_freq=T&tl_tz=-8</code></a>
  </p>
  <br/>
  <form id="tl_form">
    <div class="row">
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.tl_form.tl_lat.errors }}
        {{ forms.tl_form.tl_lat.label_tag }}
        {{ forms.tl_form.tl_lat }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.tl_form.tl_lon.errors }}
        {{ forms.tl_form.tl_lon.label_tag }}
        {{ forms.tl_form.tl_lon }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.tl_form.tl_start.errors }}
        {{ forms.tl_form.tl_start.label_tag }}
        {{ forms.tl_form.tl_start }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.tl_form.tl_end.errors }}
        {{ forms.tl_form.tl_end.label_tag }}
        {{ forms.tl_form.tl_end }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.tl_form.tl_freq.errors }}
        {{ forms.tl_form.tl_freq.label_tag }}
        {{ forms.tl_form.tl_freq }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.tl_form.tl_tz.errors }}
        {{ forms.tl_form.tl_tz.label_tag }}
        {{ forms.tl_form.tl_tz }}
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-2">
        <button id="tl_button" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </form>
  <br/>
  <p>Enter the fields above and then click submit to see what your request
    looks like and a <a href="#linketurbidity">table of Linke Turbidity</a>
    values below:</p>
  <span id="tl_code"></span>
  <div id="linketurbidity"></div>
</div>

<div class="container">
  <h1 class="page-header">Air Mass</h1>
  <p>Air mass is a measure of the path length through the atmosphere measured
  in atmospheres. On the equator at solar noon on the equinox, when the sun is
  directly overhead, the air mass is 1 atmospere. The reference atmosphere,
  <a href="https://rredc.nrel.gov/solar//spectra/am1.5/">ASTM G173-03</a>, has
  an air mass of 1.5 atmospheres, and is usually called AM1.5. It's equivalent
  to a spring noon in the southwest USA.</p>
  <h2>Example</h2>
  <p>
    You'll need to send a <code>POST</code> request with solar position data.
  </p>
  <br/>
  <form id="am_form">
    <div class="row">
      <div class="col-md-2">
        <div class="form-group">
        {{ forms.am_form.zenith_data.errors }}
        {{ forms.am_form.zenith_data.label_tag }}
        {{ forms.am_form.zenith_data }}
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-2">
        <button id="am_button" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </form>
  <br/>
  <p>Enter the fields above and then click submit to see what your request
    looks like and a <a href="#airmass">table of Linke Turbidity</a>
    values below:</p>
  <span id="am_code"></span>
  <div id="airmass"></div>
</div>
{% endblock %}

{% block footers %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<!-- <script src="{% static 'highlight/highlight.pack.js' %}"></script> -->
<script>hljs.initHighlightingOnLoad();</script>
<script>
  $(function(){$("input").addClass("form-control");});
  $(function() {
    $("#solposbutton").click( function( event ) {
      event.preventDefault();
      console.log(event);
      console.log(this);
      var items = [];
      var vega_data = [];
      var headers = ["Timestamp"];
      var is_first_row = true;
      var params = $("#solposform").serialize();
      var solpos_url = "/api/v1/pvlib/solarposition/";
      $("#solpos").empty();
      if ($("#solpos").attr("style") != null) {
        $("#solpos").removeAttr("style");
      };
      $("#solpos_code").empty();
      $("<pre>", {html: solpos_url + "?" + params}).appendTo("#solpos_code");
      $.getJSON( solpos_url, params, function( data ) {
        $.each( data, function( date, record ) {
          vega_record = {"date": date};
          row = "<tr><td><b>" + date + "</b></td>";
          $.each( record, function( col, val ) {
            vega_record[col] = val;
            row += "<td>" + val + "</td>" ;
            if (is_first_row) {
              headers.push( col );
            };
          });
          row += "</tr>"
          is_first_row = false;
          items.push( row );
          vega_data.push(vega_record);
        });
        items = "<tbody>" + items.join( "" ) + "</tbody>";
        headers = "<th>" + headers.join("</th><th>") + "</th>";
        $("#solpos").css({"height": "500px", "overflow": "auto"});
        $( "<table>", {
          "id": "solposTable",
          "class": "table table-striped table-bordered table-condensed",
          html: "<thead>" + headers + "</thead>" + items
        }).appendTo( "#solpos" );

      // Assign the specification to a local variable vlSpec.
      var vis_width = $("#solpos").width()-200;
      var vis_height = vis_width/2;
      var vlSpec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v3.json',
        title: ("solar position at (" + Math.round($('#id_lat').val(), 5)
                + "," + Math.round($('#id_lon').val(), 5) + ") from "
                + $('#id_start').val() + " to " + $('#id_end').val()),
        width: vis_width, height: vis_height,
        data: {values: vega_data},
        mark: {type: 'point', clip: true},
        encoding: {
          y: {field: 'apparent_zenith', type: 'quantitative'},
          x: {field: 'azimuth', type: 'quantitative'},
          color: {field: 'date', type: 'temporal'}
        }
      };

      // Embed the visualization in the container with id `vis`
      vegaEmbed('#vis', vlSpec);

      });
      // copy inputs from solpos to linke-turbidity
      $("#id_tl_lat").val($('#id_lat').val());
      $("#id_tl_lon").val($('#id_lon').val());
      $("#id_tl_tz").val($('#id_tz').val());
      $("#id_tl_start").val($('#id_start').val());
      $("#id_tl_end").val($('#id_end').val());
      $("#id_tl_freq").val($('#id_freq').val());
    });
  });
</script>
<script>
  $(function() {
    $("#tl_button").click( function( event ) {
      event.preventDefault();
      console.log(event);
      console.log(this);
      var items = [];
      var headers = ["Timestamp", "Linke Turbidity"];
      var params = $("#tl_form").serialize();
      var tl_url = "/api/v1/pvlib/linke-turbidity/";
      $("#linketurbidity").empty();
      if ($("#linketurbidity").attr("style") != null) {
        $("#linketurbidity").removeAttr("style");
      };
      $("#tl_code").empty();
      $("<pre>", {html: tl_url + "?" + params}).appendTo("#tl_code");
      $.getJSON( tl_url, params, function( data ) {
        $.each( data, function( date, record ) {
          row = "<tr><td><b>" + date + "</b></td><td>" + record + "</td></tr>"
          items.push( row );
        });
        items = "<tbody>" + items.join( "" ) + "</tbody>";
        headers = "<th>" + headers.join("</th><th>") + "</th>";
        $("#linketurbidity").css({"height": "500px", "overflow": "auto"});
        $( "<table>", {
          "id": "linketurbidityTable",
          "class": "table table-striped table-bordered table-condensed",
          html: "<thead>" + headers + "</thead>" + items
        }).appendTo( "#linketurbidity" );
      });
    });
  });

</script>
{% endblock footers %}
